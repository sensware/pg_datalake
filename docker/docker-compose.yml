services:
  pg_lake-postgres:
    image: pg_lake:local
    pull_policy: if_not_present
    container_name: pg_lake
    ports:
      - "5432:5432"
    volumes:
      - ./scripts/entrypoint-postgres.sh:/entrypoint-postgres.sh
      - ./scripts/init-postgres.sql:/init-postgres.sql
      - pgduck-unix-socket-volume:/home/postgres/pgduck_socket_dir
      - pg-shared-tmp-dir-volume:/home/postgres/pgsql-${PG_MAJOR:-18}/data/base/pgsql_tmp
    entrypoint: ["/entrypoint-postgres.sh"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "psql", "-c", "create table test(a int) using iceberg; drop table test;"]
      interval: 6s
      timeout: 2s
      start_period: 20s
      retries: 3
    cap_add:
      - SYS_PTRACE
    depends_on:
      - pgduck-server

  pgduck-server:
    image: pgduck-server:local
    pull_policy: if_not_present
    container_name: pgduck-server
    # NOTE: pgduck-server only listens on Unix sockets, not TCP
    # To access DuckDB from the host, connect via pg_lake-postgres container which shares the Unix socket
    # Example: psql -h localhost -p 5432 -U postgres -c "SELECT * FROM duckdb_fdw.some_table"
    # IMPORTANT: Both containers must share the same temp directory volume so pgduck_server can access temp files
    volumes:
      - ./scripts/entrypoint-pgduck-server.sh:/entrypoint-pgduck-server.sh
      - ./scripts/init-pgduck-server.sql:/init-pgduck-server.sql
      - pgduck-unix-socket-volume:/home/postgres/pgduck_socket_dir
      - pg-shared-tmp-dir-volume:/home/postgres/pgsql-${PG_MAJOR:-18}/data/base/pgsql_tmp
    entrypoint: ["/entrypoint-pgduck-server.sh"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "psql", "-p", "5332", "-h", "/home/postgres/pgduck_socket_dir", "-c", "SELECT 1;"]
      interval: 6s
      timeout: 2s
      start_period: 20s
      retries: 3
    cap_add:
      - SYS_PTRACE
    depends_on:
      - localstack

  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-main}"
    image: localstack/localstack
    pull_policy: if_not_present
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # external services port range
    environment:
      # LocalStack configuration: https://docs.localstack.cloud/references/configuration/
      - DEBUG=${DEBUG:-0}
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./.volume}:/var/lib/localstack"
      - "${PWD}/scripts/init-s3.sh:/etc/localstack/init/ready.d/init-s3.sh" 

volumes:
  pgduck-unix-socket-volume:
  pg-shared-tmp-dir-volume:  # Shared temp directory for both PostgreSQL and pgduck_server
